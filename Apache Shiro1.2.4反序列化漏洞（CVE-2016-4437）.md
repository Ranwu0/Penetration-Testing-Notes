# Apache Shiro 1.2.4反序列化漏洞（CVE-2016-4437）



# 漏洞描述

**Apache [Shiro](https://so.csdn.net/so/search?q=Shiro&spm=1001.2101.3001.7020) 框架提供了记住用户功能，即 Remember Me 功能，用户登录成功后会生成经过加密编码的 Cookie。Cookie 的键为`rememberMe` ，值是经过对相关信息进行[反序列化](https://so.csdn.net/so/search?q=反序列化&spm=1001.2101.3001.7020)后，使用 AES 加密，最后使用 Base64 编码处理**

服务器端 Cookie 处理流程：

1. 检索 Cookie 中`rememberMe`的值；
2. Base64 解码；
3. AES 解密（加密密钥硬编码）
4. 反序列化操作（未做过滤处理）

**Shiro 默认使用了 CookieRememberMeManager，加密的用户信息序列化后存储在名为`rememberMe` 的Cookie 中。攻击者可以使用 Shiro 的默认密钥伪造用户 Cookie ，触发 Java 反序列化漏洞，进而在目标机器上执行任意命令**



# 漏洞影响

**Apache Shiro <= 1.2.4**



# 漏洞检测

![img](https://img-blog.csdnimg.cn/74b6e9e3f8114aabaf4745106495ce4b.PNG?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ0ODgwMjU1,size_16,color_FFFFFF,t_70#pic_center)

**通过抓取数据登录包，判断响应值**

![img](https://img-blog.csdnimg.cn/6b548dbc843e463a99280905aabdab52.PNG?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ0ODgwMjU1,size_16,color_FFFFFF,t_70#pic_center)

**发现响应中有rememberMe=deleteMe，漏洞存在。**



# ShiroExploit

![打开漏洞检测工具](https://img-blog.csdnimg.cn/6fef84be2d3346dabb5883ad0022f18d.png)

**界面内容简介：**
**–漏洞类型Shiro550-无需选择操作系统类型，无需提供rememberMe Cookie**
**–漏洞类型Shiro721-需要选择操作系统类型，需要提供一个有效的rememberMe Cookie**
**–复杂Http请求-支持直接粘贴数据包**
**–可以手工指定特定的 Key 和 Gadget，默认不指定，会遍历所有的 Key 和 Gadget**
**…**

**3）此处，直接使用工具检测 Shiro-550 漏洞，在目标地址的位置输入要检测的URL，点击下一步**

![在这里插入图片描述](https://img-blog.csdnimg.cn/20201119165624553.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MDQxMjAzNw==,size_16,color_FFFFFF,t_70#pic_center)

**使用ceye.io进行漏洞检测**

![在这里插入图片描述](https://img-blog.csdnimg.cn/20201119165730728.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MDQxMjAzNw==,size_16,color_FFFFFF,t_70#pic_center)

稍等片刻，如果不存在漏洞就弹窗提示“不存在shiro反序列化漏洞”，存在漏洞的话就如下图所示

![在这里插入图片描述](https://img-blog.csdnimg.cn/20201124130219102.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MDQxMjAzNw==,size_16,color_FFFFFF,t_70#pic_center)

因为目标网站是Linux，所以反弹shell，写上反弹的地址与端口，点击fire

![在这里插入图片描述](https://img-blog.csdnimg.cn/20201124130525724.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MDQxMjAzNw==,size_16,color_FFFFFF,t_70#pic_center)

![在这里插入图片描述](https://img-blog.csdnimg.cn/20201124130510272.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MDQxMjAzNw==,size_16,color_FFFFFF,t_70#pic_center)

反弹成功的话下面会提示一段话，如下图所示

![在这里插入图片描述](https://img-blog.csdnimg.cn/2020112413054512.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MDQxMjAzNw==,size_16,color_FFFFFF,t_70#pic_center)

可以看到kali的nc已经接收到了反弹的shell，并且使root权限

![在这里插入图片描述](https://img-blog.csdnimg.cn/20201124130601551.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MDQxMjAzNw==,size_16,color_FFFFFF,t_70#pic_center)

# shiro_attack-2.2

输入目标url,可以选择是post还是get。可以指定密钥可以爆破。可以爆破利用链及回显方式。下面有检测日志，命令执行，内存马等选项进行配置

![在这里插入图片描述](https://img-blog.csdnimg.cn/a095f4ede71146b9a62be8561402dec1.png)

![在这里插入图片描述](https://img-blog.csdnimg.cn/425b4ca171f44f38a4b9a526421ce5b9.png)

**我在测试过程中，有时候用ShiroExploit没检测出来，但是用shiro_attack却检测出来了。建议两种工具都检测下。**
**当然了，最靠谱的还是升级shiro版本来避免该漏洞的发生！**

