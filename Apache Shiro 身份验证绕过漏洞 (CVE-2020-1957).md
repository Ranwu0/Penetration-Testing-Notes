# Apache Shiro 身份验证绕过漏洞 (CVE-2020-1957)

# 漏洞描述

Apache Shiro 是一款开源安全框架，提供身份验证、授权、密码学和会话管理。Shiro框架直观、易用，同时也能提供健壮的安全性。
CVE-2020-1957，Spring Boot中使用 Apache Shiro 进行身份验证、权限控制时，可以精心构造恶意的URL，利用 Apache Shiro 和 Spring Boot 对URL的处理的差异化，可以绕过 Apache Shiro 对 Spring Boot 中的 Servlet 的权限控制，越权并实现未授权访问

**Shiro[框架](https://so.csdn.net/so/search?q=框架&spm=1001.2101.3001.7020)通过拦截器功能来对用户访问权限进行控制，**
**如anon, authc等[拦截器](https://so.csdn.net/so/search?q=拦截器&spm=1001.2101.3001.7020)。anon为匿名拦截器，不需要登录即可访问；authc为登录拦截器，需要登录才可以访问。主要是Spring web在匹配url的时候没有匹配上/导致绕过**



# 影响范围

Shiro < 1.5.3



# 漏洞复现

环境启动后，访问`http://x.x.x.x:8080`即可查看首页:

![在这里插入图片描述](https://img-blog.csdnimg.cn/7a12f13f5fb8439b86a50b527b1b51aa.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NDAzNzI5Ng==,size_16,color_FFFFFF,t_70)

这个应用中对URL权限的配置如下：

```java
@Bean
public ShiroFilterChainDefinition shiroFilterChainDefinition() {
    DefaultShiroFilterChainDefinition chainDefinition = new DefaultShiroFilterChainDefinition();
    chainDefinition.addPathDefinition("/login.html", "authc"); // need to accept POSTs from the login form
    chainDefinition.addPathDefinition("/logout", "logout");
    chainDefinition.addPathDefinition("/admin/**", "authc");
    return chainDefinition;
}
```

使用BurpSuite抓取数据包，访问`/admin/`目录

![在这里插入图片描述](https://img-blog.csdnimg.cn/d18f14b8f4d34397b3d5538ee54c18fd.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NDAzNzI5Ng==,size_16,color_FFFFFF,t_70)

回显`302`并跳转到登录页面：

![在这里插入图片描述](https://img-blog.csdnimg.cn/ef4439488c8d4d2b962eeaac58e8a7d6.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NDAzNzI5Ng==,size_16,color_FFFFFF,t_70)

构造恶意请求`/xxx/..;/admin/`，即可绕过权限校验，访问到管理页面：

![在这里插入图片描述](https://img-blog.csdnimg.cn/8d7122ed57fe45e68b7ac65dc3d06411.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NDAzNzI5Ng==,size_16,color_FFFFFF,t_70)

URL请求过程：

- 客户端请求URL: `/xxx/..;/admin/`
- Shrio 内部处理得到校验URL为 `/xxxx/..`,校验通过
- SpringBoot 处理 `/xxx/..;/admin/` , 最终请求 `/admin/`, 成功访问了后台请求。

# 漏洞POC

构造恶意请求`/xxx/..;/admin/`，即可绕过权限校验，访问到管理页面。



# 修复方案

更新为最新版本或打上厂商更新的补丁